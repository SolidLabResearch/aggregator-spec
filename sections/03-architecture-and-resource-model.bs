Architecture & Resource Model {#architecture-resource-model}
===========================================================

This section describes the high-level architecture of an Aggregator deployment and the resource model exposed by this specification.
It connects the terminology in [[#definitions]] to the endpoint definitions in later sections.

Actors and Responsibilities {#architecture-actors}
-------------------------------------------------

The protocol distinguishes the following parties:

- **Client:** An application acting on behalf of an end-user to create Aggregator Instances and configure Aggregator Services.
- **Aggregator Server:** The server that exposes public discovery information and a registration API to create Aggregator Instances.
- **Aggregator Instance:** A user-specific (or tenant-specific) logical instance created via registration, exposing instance metadata and a management API.
- **Aggregator Service:** A configured data-processing pipeline created and managed within an Aggregator Instance.
- **Identity Provider (IdP):** Issues OIDC tokens used to prove identity as part of registration and upstream authorization flows.
- **Authorization Server (AS):** A UMA-capable OAuth2 Authorization Server that issues RPTs for protected resources.
- **Resource Server (RS):** An upstream resource server hosting data that the Aggregator Service may access on behalf of the user.

Resource Types {#resource-types}
-------------------------------

This specification defines HTTP resources at three levels:

- **Aggregator Server resources:** discovery and registration (see [[#aggregator-server-discovery]] and [[#aggregator-registration]]).
- **Aggregator Instance resources:** instance metadata and management (see [[#aggregator-instance-metadata]] and [[#aggregator-management-api]]).
- **Aggregator Service resources:** a service collection and service members managed under the instance (see [[#config-services]] and [[#config-services-service-id]]).

Base URLs and Addressing {#base-urls-and-addressing}
---------------------------------------------------

An implementation MUST define a stable base URL for:

- the Aggregator Server (the _server base URL_); and
- each Aggregator Instance (the _instance base URL_).

All paths in this specification are expressed relative to either the server base URL or the instance base URL:

- **Server-relative resources:** the server metadata resource at `/` (see [[#server-metadata-resource]]), the registration API at `/registration` (see [[#aggregator-registration]]), and the public resources `./client.json` and `./transformations` (see [[#client-metadata-document]] and [[#transformation-catalog]]).
- **Instance-relative resources:** the instance metadata resource at `/` (see [[#aggregator-instance-metadata]]) and the management API under `/config/*` (see [[#aggregator-management-api]]).

An implementation MAY use either of the following instance addressing patterns:

- **Host-based instances:** `https://{instance-id}.aggregator.example/`
- **Path-based instances:** `https://aggregator.example/{instance-id}/`

If an implementation supports multiple patterns, it MUST ensure that URLs returned in representations are self-consistent for a given instance (i.e., all links for that instance share the same instance base URL).
Clients SHOULD treat server-provided URLs as authoritative and avoid constructing URLs by string concatenation.

Discovery and Entry Points {#discovery-and-entry-points}
--------------------------------------------------------

- The Aggregator Server exposes a public discovery resource at its server base URL (see [[#server-metadata-resource]]).
- Clients create (or obtain access to) an Aggregator Instance via the registration API (see [[#aggregator-registration]]).
- The resulting instance base URL is the entry point for instance metadata (see [[#aggregator-instance-metadata]]) and instance management (see [[#aggregator-management-api]]).

Security Boundaries {#security-boundaries}
-----------------------------------------

All security requirements are defined in [[#security-model]].
At a high level:

- Public (no authentication): the server metadata resource (see [[#server-metadata-resource]]) and the resources it links to, such as the transformation catalog and client metadata document (see [[#transformation-catalog]] and [[#client-metadata-document]]).
- Protected (UMA): the instance metadata resource (see [[#aggregator-instance-metadata]]) and all resources under the management API (see [[#aggregator-management-api]]).

Example URL Layout (Non-normative) {#example-url-layout}
-------------------------------------------------------

Given an Aggregator Server at `https://aggregator.example/` and a path-based Aggregator instance at `https://aggregator.example/abc123/`:

- Server metadata: `https://aggregator.example/`
- Registration: `https://aggregator.example/registration`
- Transformation catalog: `https://aggregator.example/transformations`
- Instance metadata: `https://aggregator.example/abc123/`
- Instance Transformation catalog: `https://aggregator.example/abc123/config/transformations`
- Service collection: `https://aggregator.example/abc123/config/services`

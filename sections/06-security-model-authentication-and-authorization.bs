Aggregator Security Model (Authentication & Authorization) {#aggregator-security-model}
===============================================================

This section describes how the Aggregator handles authentication and authorization for:

- outgoing requests from the Aggregator to upstream Resource Servers; and
- incoming requests from Clients to the Aggregator.

The Aggregator relies on the Authorization for Data Spaces (A4DS) specification [[!A4DS]] to authenticate Clients and 
authorize access to resources. For streaming or non-HTTP interfaces, the Aggregator MAY additionally use the Service 
Authorization for Data Spaces (SA4DS) specification [[!SA4DS]]. All Aggregator endpoints are protected using User-Managed 
Access (UMA) [[!UMA]].

In this section, the **Upstream Resource Server (URS)** is the Resource Server that hosts the original data the
Aggregator consumes. The **Upstream Authorization Server (UAS)** is the Authorization Server that protects that URS and
issues access tokens for those upstream resources. The **Aggregator Authorization Server (AAS)** is the Authorization
Server that protects the Aggregator itself and issues tokens (e.g., UMA RPTs) for access to derived resources.

NOTE: The following behavior is an extension of the [[!A4DS]] specification.

Upstream Access (Requesting) {#requesting-flow}
----------------------------------------------

**Normative requirements**

The Aggregator Service MUST obtain upstream access tokens according to A4DS and UMA and if asked for a proof of identity MUST
present the ID token (`IDP_aggregator_token`) obtained during aggregator registration ([[#aggregator-registration]]). When
the Aggregator Service intends to create derived resources, it MUST request a global scope
`urn:knows:uma:scopes:derivation-creation`. The Aggregator Service MAY include a transformation description claim token
([[!A4DS]]). The `claim_type` for this description MUST be
`https://spec.knows.idlab.ugent.be/aggregator-protocol/latest/#transformation-description`. The `claim_token_format` values
identify acceptable RDF serializations as URIs (e.g., `http://www.w3.org/ns/formats/Turtle`). The Upstream Authorization
Server MAY require transformation description claims; if it does, it MUST respond with a UMA `need_info` error and
`required_claims` as defined by [[!A4DS]].

If the UAS grants access to the upstream resource to create the derived resource it MUST include a `derivation_resource_id`
and a `management_access_token` field in the access-token response body, as top-level members alongside the standard OAuth
2.0 token response parameters (e.g., `access_token`, `refresh_token`, `expires_in`). The `derivation_resource_id` is a unique
identifier string that links the requested data and the intended transformation to the derived resource that the Aggregator
Service will create. If the Aggregator Service previously obtained a `derivation_resource_id` for the same upstream
resource and transformation, it SHOULD include it in the token request using the `derivation_resource_id` field. If the
hint is still valid and bound to the authenticated Aggregator and resource, the UAS SHOULD reuse it; otherwise it SHOULD
ignore it and issue a new identifier. The UAS MUST include a `derivation_resource_id` in successful access-token responses
for derivation creation. Access tokens MAY be reused until they expire or are revoked. If the aggregator does not receive a
`derivation_resource_id`, it MUST NOT use the upstream resource to create derived resources. The `management_access_token`,
if provided, is an object with `access_token`, `token_type` fields that allows the Aggregator Service to manage the
lifecycle of the `derivation_resource_id` at the UAS trough the resource registration endpoint defined in [[!A4DS]].
Authorization Servers MUST only allow a `management_access_token` to be used for inspecting or modifying the
`derivation_resource_id` resource linked to it and MUST NOT allow them to create new resources. The Aggregator SHOULD
modify the `derivation_resource_id` resource on the UAS to add the scopes, name, description, and icon_uri of the derived
resource. If the `management_access_token` is not valid anymore the Aggregator can request a new one by repeating the access
token request including the same `derivation_resource_id`. If access to the upstream resource is revoked for the Aggregator,
the UAS MUST also revoke all associated `derivation_resource_id` identifiers and their access tokens.

The Aggregator Service MUST modify the asset representing the derived resource on the AAS with a `derived_from`
entry containing the `issuer` (the UAS) and `derivation_resource_id` as described by [[!A4DS]]. The AAS MUST expire
previous access tokens for that derived resource. The Aggregator Service SHOULD only use the data from resource after a
successful resource registration update at the AAS. When a derived resource is no longer used, the Aggregator Service
SHOULD remove the `derived_from` entry, MAY expire previous access tokens, and SHOULD delete the `derivation_resource_id`
at the UAS trough the resource registration endpoint.

**Non-normative flow and examples**

<pre class="plantuml">
@startuml
skinparam participantStyle rectangle

participant "Aggregator Service âš™ï¸" as A
participant "Aggregator Authorization Server ðŸ›¡ï¸" as AAS
participant "Upstream Resource Server ðŸ“¦" as URS
participant "Upstream Authorization Server ðŸ›¡ï¸" as UAS
participant "Identity Provider ðŸ”" as IdP

A -> URS: 1. Request resource (no access token)
URS -> UAS: 1.1 Request UMA ticket for resource
URS --> A: 1.2 401 Unauthorized + UMA ticket

A -> UAS: 2. Request access token
UAS -> IdP: 2.1 Validate IDP_aggregator_token
UAS --> A: 2.2 Request transformation claim
A -> UAS: 2.3 Request access token (with transformation claim)
UAS --> A: 2.4 access_token + derivation_resource_id + management_access_token

A -> URS: 3. Request resource with access token

A -> UAS: 4. Update derivation_resource_id metadata on UAS

A -> AAS: 5. Update resource registration at AAS

@enduml
</pre>

**1. Requesting the upstream resource without token**

The Aggregator Service requests the upstream resource without an access token.

<div class="example">
```http
GET /resource/123 HTTP/1.1
Host: upstream.example.org
```
</div>

**1.1 URS requests ticket from UAS**

Assuming the resource is protected with UMA, the Upstream Resource Server requests a UMA ticket from its Upstream
Authorization Server, as described in [[!A4DS]].

**1.2 URS returns ticket**

The Upstream Resource Server returns the ticket it got from the UAS to the Aggregator Service.

<div class="example">
```http
HTTP/1.1 401 Unauthorized
WWW-Authenticate: UMA as_uri="https://upstream.as.example.org/uma", ticket="tkt1-URS-xyz"
```
</div>

**2. Requesting an access token from the UAS**

Using the `IDP_aggregator_token` obtained during registration, the Aggregator Service requests an access token from the 
UAS. The request includes the derivation-creation scope to notify the UAS we want to create a derived resource. If the
Aggregator has previously obtained a `derivation_resource_id` for the same upstream resource and transformation, it should
include it as a hint using the `derivation_resource_id` parameter.

<div class="example">
```http
POST /token HTTP/1.1
Host: upstream.as.example.org
Content-Type: application/json
{
    "grant_type": "urn:ietf:params:oauth:grant-type:uma-ticket",
    "ticket": "tkt1-URS-xyz",
    "scope": "urn:knows:uma:scopes:derivation-creation",
    "claim_token": "<IDP_aggregator_token>",
    "claim_token_format": "http://openid.net/specs/openid-connect-core-1_0.html#IDToken"
}
```
</div>

**2.1 UAS validates the IDP_aggregator_token**

The Upstream Authorization Server validates the `IDP_aggregator_token` with the Identity Provider that issued it as
described in [[!OIDC-Core]].

**2.2 Request transformation claim**

If the Upstream Authorization Server needs details about the intended transformation, it can request them using UMA
`need_info` with a transformation claim type.

<div class="example">
```json
{
  "error": "need_info",
  "ticket": "tkt2-URS-xyz",
  "required_claims": [
    {
      "claim_type": "https://spec.knows.idlab.ugent.be/aggregator-protocol/latest/#transformation-description",
      "friendly_name": "Intended data transformation",
      "claim_token_format": [
        "http://www.w3.org/ns/formats/Turtle",
        "http://www.w3.org/ns/formats/JSON-LD"
      ],
      "claim_description": "Describe the transformation that will be executed on the requested data (e.g. query, mapping, model, or workflow reference)."
    }
  ]
}
```
</div>

**2.3 Requesting an access token and push transformation claim**

The Aggregator then resubmits the token request with an additional claim token describing the intended transformation.
If the service description or transformation catalogs are dereferenceable by the UAS, the Aggregator can provide those
URIs rather than embedding a full description.

<div class="example">
```http
POST /token HTTP/1.1
Host: upstream.as.example.org
Content-Type: application/json
{
    "grant_type": "urn:ietf:params:oauth:grant-type:uma-ticket",
    "ticket": "tkt2-URS-xyz",
    "scope": "urn:knows:uma:scopes:derivation-creation",
    "claim_token": "<transformation_description>",
    "claim_token_format": "http://www.w3.org/ns/formats/Turtle"
}
```
</div>

**2.4 UAS returns access token and derivation resource identifier**

Adding the derivation creation scope signals to the Upstream Authorization Server that the Aggregator intends to create a
derived resource based on the requested upstream resource. The Upstream Authorization Server includes a
`derivation_resource_id` and a `management-access-token` in the response. The `derivation_resource_id` is a unique
identifier for the derived resource on the aggregator for the UAS. The Aggregator will uses this id to require users to get
claims from the UAS when they want to access the derived resource. The `management_access_token` allows the Aggregator to
manage the lifecycle of the `derivation_resource_id` at the UAS, for example by updating its scopes or deleting it when
the derived resource is no longer offered by the Aggregator.

<div class="example">
```http
HTTP/1.1 200 OK
Content-Type: application/json
{
    "access_token": "<upstream_access_token>",
    "token_type": "Bearer",
    "derivation_resource_id": "handle-id-1",
    "management_access_token": {
        "access_token": "<management_access_token>",
        "token_type": "Bearer"
    }
}
```
</div>

**3. Accessing the upstream resource with token**

The Aggregator Service then requests the resource from the Upstream Resource Server using the access token obtained from
the Upstream Authorization Server. This access token MAY be used multiple times until it expires or is revoked as described
in [[!A4DS]].

**4. Update the metadata of the derived resource on the UAS**

The Aggregator Service needs to update the metadata on the resource identified by `derivation_resource_id` at the UAS to
at least include the scopes of the derived resource. This way, when a client requests access to the derived resource and
needs to get claims from the UAS, the UAS can check if the requested scopes are valid for that `derivation_resource_id` and
include them in the `required_claims` of the UMA `need_info` response. Furthermore, the UAS can set policies based on these
scopes to determine whether to grant access to the derivation resource.

<div class="example">
```http
PUT /derivation-resources/handle-id-1 HTTP/1.1
Host: upstream.as.example.org
Authorization: Bearer <management_access_token>
Content-Type: application/json
{
  "type": "https://agg.example.org/derivation-result",
  "name": "Derived Resource 123",
  "description": "<transformation_description>",
  "icon_uri": "https://agg.example.org/icons/derived-resource-123.png",
  "resource_scopes": [
    "urn:knows:uma:scopes:read"
  ]
}
```
</div>

**5. Resource registration of the Aggregator Service**

Finally, the Aggregator Service updates the resource registration at its own Authorization Server (the AAS) to signal that
it used this `derivation_resource_id` to create derived resources.

<div class="example">
```http
PUT /resource-registration/agg-service-123 HTTP/1.1
Host: as.example.org
Content-Type: application/json
{
  ...
  "derived_from": [
    {
      "issuer": "https://as.example.org",
      "derivation_resource_id": "handle-id-1"
    }
  ],
  "resource_scopes": [
    "urn:knows:uma:scopes:read"
  ]
}
```
</div>

If a resource is no longer used, the Aggregator Service can update the resource registration to remove the
`derivation_resource_id` from the `derived_from` relations and delete the identifier at the Upstream Authorization
Server using the `management_access_token`.

Client Access (Serving) {#serving-flow}
--------------------------------------

**Normative requirements**

All endpoints on the Aggregator SHOULD be protected using an AS defined during registration. The Aggregator acts as a 
Resource Server in UMA terminology. So when the Aggregator receives a request without a valid Requesting Party Token (RPT) 
from a client it MUST request a UMA ticket from its Authorization Server and return `401 Unauthorized` with that ticket.
RPT validity is discussed in more detail in [[!A4DS]]. If this is a request for a derived resource, the Aggregator Service 
SHOULD make sure that the `derivation_resource_id` used to create the derived resource is still valid by inspecting the 
asset on the UAS by using the `management_access_token` on the resource registration endpoint as described in [[!A4DS]].

The Client SHOULD present the UMA ticket from the Aggregator response to the AAS to obtain an RPT as defined in [[!A4DS]]. 
Additionally to A4DS, if this is a request to access a derived resource, the requested resource may have a `derived_from` 
entry in its registration that includes one or more `issuer` (the UAS) and `derivation_resource_id` entries. If no claims 
are given by the Client for these derived resources, the AAS MUST respond with a `need_info` error and include a 
`required_claims` list where each object MUST contain:
- `claim_type`: MUST equal `https://spec.knows.idlab.ugent.be/aggregator-protocol/latest/#derivation-access`.
- `claim_token_format`: MUST equal `urn:ietf:params:oauth:token-type:access_token`.
- `issuer`: The UAS that issued the upstream access token.
- `derivation_resource_id`: The derived resource identifier received from the UAS.
- `resource_scopes`: A list of scopes for the derived resource (e.g., `urn:knows:uma:scopes:read`)

The Client SHOULD request upstream access tokens at the described `issuer` (the UAS) with a `permissions` field where
`resource_id` is set to `derivation_resource_id` and `resource_scopes` is set to `resource_scopes` from the
`required_claims` response. After the Client has obtained the required upstream access tokens, it SHOULD present them as
claims to the AAS as described by [[!A4DS]]. Each claim token MUST have a `claim_token_format` of
`urn:ietf:params:oauth:token-type:access_token` and the `claim_token` value is the upstream access token itself.
The Aggregator Authorization Server MUST validate the provided upstream access tokens with the corresponding upstream
Authorization Servers; if checks succeed, it issues an RPT for the derived resource. The Aggregator Service MUST validate
or introspect the RPT before serving the derived resource. The Aggregator MAY implement SA4DS for streaming or non-HTTP
interfaces.

**Non-normative flow and examples**

<pre class="plantuml">
@startuml
skinparam participantStyle rectangle

participant "Client ðŸ§‘â€ðŸ’»" as C
participant "Aggregator Service âš™ï¸" as A
participant "Aggregator Authorization Server ðŸ›¡ï¸" as AAS
participant "Upstream Authorization Server ðŸ›¡ï¸" as UAS

C -> A: 1. Request derived resource (no auth header)
A -> AAS: 1.1 Request UMA ticket for resource
A --> C: 1.2 401 Unauthorized + UMA ticket

C -> AAS: 2. Request permission with ticket
AAS --> C: 2.1 need_info + required_claims

C -> UAS: 3. Request upstream access token for derivation_resource_id
UAS --> C: 3.1 Upstream access token

C -> AAS: 4. Request permission with upstream access token
AAS --> C: 4.1 RPT for Aggregator resource

C -> A: 5. Request derived resource with RPT
A -> AAS: 5.1 Introspect RPT
AAS --> A: 5.2 Authorization result
A --> C: 5.3 Derived resource

@enduml
</pre>

**1. Client requests derived resource from Aggregator Service without token**

The Client sends a request to the Aggregator Service for a derived resource without including a valid
Requesting Party Token (RPT), or with an RPT that does not grant sufficient permission.

<div class="example">
```http
GET /aggregator/derived-resource-123 HTTP/1.1
Host: agg.example.org
```
</div>

**1.1 Aggregator Service requests UMA ticket from its Authorization Server**

The Aggregator Service, acting as a UMA Resource Server, requests a UMA ticket for the requested derived resource from its 
Authorization Server (the AAS).

**1.2 Aggregator Service returns 401 Unauthorized with ticket**

The Aggregator Service returns a `401 Unauthorized` response containing the UMA ticket and the AAS location.

<div class="example">
```http
HTTP/1.1 401 Unauthorized
WWW-Authenticate: UMA as_uri="https://agg-as.example.org/", ticket="tkt-1"
```
</div>

**2. Client presents ticket to Aggregator Authorization Server**

The Client discovers the token endpoint for the AAS and sends a UMA grant request to exchange the ticket for an RPT.
The Client includes any claim tokens it already has (for example, its `IDP_client_token`) in the request.

<div class="example">
```json
{
  "grant_type": "urn:ietf:params:oauth:grant-type:uma-ticket",
  "ticket": "tkt-1",
  "claim_token": "<IDP_client_token>",
  "claim_token_format": "http://openid.net/specs/openid-connect-core-1_0.html#IDToken"
}
```
</div>

**2.1 Aggregator Authorization Server introspects Client access tokens**

If access to the derived resource depends on access to upstream resources, and the Client has not yet presented suitable 
upstream access tokens, the Aggregator Authorization Server responds with a `need_info` error requesting additional claim 
tokens for the upstream resources. In that case, the Authorization Server adds the `claim_type`, `claim_token_format`,
`issuer`, `derivation_resource_id`, and `resource_scopes` entries to the `required_claims` array to indicate which upstream
Authorization Server and which resource the Client must obtain access tokens from.

- **`claim_type`:** MUST equal `https://spec.knows.idlab.ugent.be/aggregator-protocol/latest/#derivation-access` to
    indicate that the claim tokens requested are access tokens for upstream resources.
- **`claim_token_format`:** MUST equal `urn:ietf:params:oauth:token-type:access_token` to indicate that the claim tokens
    requested are OAuth 2.0 access tokens.
- **`issuer`:** Identifies the upstream Authorization Server.
- **`derivation_resource_id`:** Is the resource id the UAS used to identify the derived resource when the Aggregator
    requested access to create a derived resource based on an upstream resource.
- **`resource_scopes`:** Array that enumerates the resource scopes required to access the derived resource.

<div class="example">
```json
{
  "error": "need_info",
  "ticket": "tkt-2",
  "required_claims": [
    {
      "claim_type": "https://spec.knows.idlab.ugent.be/aggregator-protocol/latest/#derivation-access",
      "claim_token_format": "urn:ietf:params:oauth:token-type:access_token",
      "issuer": "https://as.example.org",
      "derivation_resource_id": "handle-id-1",
      "resource_scopes": [ "urn:knows:uma:scopes:read" ]
    }
  ]
}
```
</div>

**3. Client requests upstream access tokens**

The Client then requests access tokens from the issuer (the UAS) with the required permissions (resource_id &
resource_scopes).

<div class="example">
```json
{
  "grant_type": "urn:ietf:params:oauth:grant-type:uma-ticket",
  "permissions": [
    {
      "resource_id": "handle-id-1",
      "resource_scopes": [ "urn:knows:uma:scopes:read" ]
    }
  ],
  "claim_token": "<IDP_aggregator_token>",
  "claim_token_format": "http://openid.net/specs/openid-connect-core-1_0.html#IDToken"
}
```
</div>

**3.1 UAS returns upstream access tokens**

The UAS validates the claims and policies and issues an access token for the derivation resource.

<div class="example">
```json
{
  "access_token": "RPT-uas-xyz",
}
```
</div>

**4. Client presents upstream tokens to Aggregator Authorization Server**

Once the Client has obtained the required upstream access tokens, it sends another request to the Aggregator Authorization 
Server, presenting the upstream access tokens (here only one) as claim tokens together with the new ticket.

<div class="example">
```json
{
  "grant_type": "urn:ietf:params:oauth:grant-type:uma-ticket",
  "ticket": "tkt-2",
  "claim_token_format": "urn:ietf:params:oauth:token-type:access_token",
  "claim_token": "RPT-uas-xyz"
}
```
</div>

**4.1 AAS verifies upstream tokens and returns RPT**

The Aggregator Authorization Server verifies the provided access tokens with the Upstream Authorization
Servers to confirm that the tokens are valid. If all policy checks succeed, it issues an RPT for the requested derived
resource.

<div class="example">
```json
{
    "access_token": "RPT-agg-1",
    "token_type": "Bearer",
    "expires_in": 3600
}
```
</div>

**5. Client requests derived resource from Aggregator Service with RPT**

Finally, the Client retries the original request to the Aggregator Service, this time including the RPT it
obtained from the Aggregator Authorization Server.

<div class="example">
```http
GET /aggregator/derived-resource-123 HTTP/1.1
Host: agg.example.org
Authorization: Bearer RPT-agg-1
```
</div>

**5.1 Aggregator Service introspects RPT**

The Aggregator Service introspects the RPT with the Aggregator Authorization Server to validate it and determine the 
permissions granted to the Client.

<div class="example">
```http
POST /introspect HTTP/1.1
Host: agg-as.example.org
Accept: application/json
Content-Type: application/x-www-form-urlencoded
token=RPT-agg-1
```
</div>

**5.2 AAS returns authorization result**

The Aggregator Authorization Server responds to the introspection request indicating whether the RPT is active and what 
permissions it grants.

<div class="example">
```json
{
    "active": true,
}
```
</div>

**5.3 Aggregator Service returns derived resource**

The Aggregator Service returns the requested derived resource to the Client.
